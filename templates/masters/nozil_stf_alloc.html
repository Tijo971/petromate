{% extends "masters/base.html" %}
{% load static %}

{% block content %}

<div class="container mt-4">

    <!-- Page Title -->
    <div class="mb-4">
        <h3 class="fw-bold">Nozzle Staff Allocation</h3>
    </div>

    <div class="row g-4">

        <!-- LEFT: Staff Selection -->
        <div class="col-xl-4 col-lg-5 col-md-12 allocation-fixed">
            <div class="card shadow-sm h-100 allocation-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Allocation Form</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="allocationForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Select Staff</label>
                            <select class="form-select" id="staffSelect" name="staff_id" required onchange="loadStaffDetails()">
                                <option value="" selected>-- Choose Staff --</option>
                                <option value="all-staffs">All Staffs</option>
                                {% for staff in staff_list %}
                                    <option value="{{ staff.id }}" {% if editing_staff and staff.id == editing_staff.id %}selected{% endif %}>
                                        {{ staff.staff_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Hidden inputs for dynamic allocations -->
                        <div id="dynamicAllocations"></div>

                        <button type="submit" class="btn btn-warning w-100 mt-3">
                            Save Allocations
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- RIGHT: Staff Allocation Details -->
        <div class="col-xl-8 col-lg-7 col-md-12">

            <!-- STAFF DETAILS TABLE -->
            <div class="card shadow-sm {% if not staff_list %}d-none{% endif %}" id="detailsCard">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Staff Allocation Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Staff Name</th>
                                    <th>Tank Name</th>
                                    <th>Nozzle Name</th>
                                    <th class="text-center">Edit</th>
                                </tr>
                            </thead>
<tbody id="staffTableBody">
{% for row in staff_table_data %}
    <tr>
        <td>{{ row.staff.staff_name }}</td>

        {% if row.allocations %}
            <td>
                {% for alloc in row.allocations %}
                    {{ alloc.tank_name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>
                {% for alloc in row.allocations %}
                    {{ alloc.nozzle_name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
        {% else %}
            <td class="text-center">-</td>
            <td class="text-center">-</td>
        {% endif %}

        <td class="text-center">
            <button class="btn btn-warning btn-sm" onclick="openEditForm({{ row.staff.id }})">
                Edit
            </button>
        </td>
    </tr>
{% empty %}
    <tr>
        <td colspan="4" class="text-center">No staff found.</td>
    </tr>
{% endfor %}
</tbody>









                        </table>
                    </div>
                </div>
            </div>

            <!-- EDIT FORM -->
            <div class="card shadow-sm mt-4 d-none" id="editFormCard">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Edit Allocations</h5>
                </div>
                <div class="card-body">

                    <!-- Allocations Table -->
                    <div class="table-responsive mb-3">
                        <table class="table table-bordered text-center align-middle" id="editAllocatedTable">
                            <thead class="bg-primary text-black">
                                <tr>
                                    <th>Product Name</th>
                                    <th>Tank Name</th>
                                    <th>Nozzle Name</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="editAllocatedBody"></tbody>
                        </table>
                    </div>

                    <!-- Add New Allocation -->
                    <h5 class="fw-bold mb-3">Add New Allocation</h5>
                    <div class="table-responsive mb-3">
                        <table class="table table-bordered text-center align-middle">
                            <thead class="bg-primary text-black">
                                <tr>
                                    <th>Product Name</th>
                                    <th>Tank Name</th>
                                    <th>Nozzle Name</th>
                                    <th>Add</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <select class="form-select" id="newProduct">
                                            {% for product in tank_entries %}
                                                <option value="{{ product.product_name }}">{{ product.product_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select" id="newTank">
                                            {% for product in tank_entries %}
                                                <option value="{{ product.tank.tank_name }}">{{ product.tank.tank_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select" id="newNozzle">
                                            {% for nozzle in nozzle_entries %}
                                                <option value="{{ nozzle.nozzle_name }}">{{ nozzle.nozzle_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-success btn-sm" onclick="addAllocation()">
                                            Add
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

        </div> <!-- END RIGHT SIDE -->

    </div> <!-- END ROW -->

</div>

<!-- JS SECTION -->
<script>
/* ===============================
   STAFF DATA FROM DJANGO
================================ */
const staffData = [
{% for staff in staff_list %}
    {
        id: {{ staff.id }},
        staff_name: "{{ staff.staff_name|escapejs }}",
        allocations: [
            {% for alloc in staff.nozzle_allocations.all %}
            {
                product: "{{ alloc.product_name|escapejs }}",
                tank: "{{ alloc.tank_name|escapejs }}",
                nozzle: "{{ alloc.nozzle_name|escapejs }}"
            },
            {% endfor %}
        ]
    },
{% endfor %}
];

const dynamicAllocations = document.getElementById("dynamicAllocations");


/* ===============================
   OPEN EDIT FORM
================================ */


function openEditForm(staffId) {
    const card = document.getElementById("editFormCard");
    const tableBody = document.getElementById("editAllocatedBody");
    const staff = staffData.find(s => s.id == staffId);

    tableBody.innerHTML = "";
    dynamicAllocations.innerHTML = "";

    staff.allocations.forEach(alloc => {
        addAllocationRow(alloc.product, alloc.tank, alloc.nozzle);
    });

    card.classList.remove("d-none");
}


/* ===============================
   LOAD STAFF DETAILS
================================ */
function loadStaffDetails() {
    const selectedStaff = document.getElementById("staffSelect").value;
    const detailsCard = document.getElementById("detailsCard");
    const tableBody = document.getElementById("staffTableBody");

    tableBody.innerHTML = "";

    if (!selectedStaff) {
        detailsCard.classList.add("d-none");
        return;
    }

    detailsCard.classList.remove("d-none");

    let filteredStaff = staffData;
    if (selectedStaff !== "all-staffs") {
        filteredStaff = staffData.filter(s => s.id == selectedStaff);
    }

    filteredStaff.forEach(staff => {
if (staff.allocations.length === 0) {
    tableBody.innerHTML += `
        <tr>
            <td>${staff.staff_name}</td>
            <td>-</td>
            <td>-</td>
            <td class="text-center">
                <button class="btn btn-warning btn-sm"
                        onclick="openEditForm(${staff.id})">
                    Edit
                </button>
            </td>
        </tr>`;
}

        staff.allocations.forEach(alloc => {
            tableBody.innerHTML += `
                <tr>
                    <td>${staff.staff_name}</td>
                    <td>${alloc.tank}</td>
                    <td>${alloc.nozzle}</td>
                    <td class="text-center">
                        <button class="btn btn-warning btn-sm"
                                onclick="openEditForm(${staff.id})">
                            Edit
                        </button>
                    </td>
                </tr>`;
        });
    });
}


/* ===============================
   ADD NEW ALLOCATION
================================ */
function addAllocation() {
    const product = document.getElementById("newProduct").value;
    const tank = document.getElementById("newTank").value;
    const nozzle = document.getElementById("newNozzle").value;

    if (!product || !tank || !nozzle) {
        alert("Please select Product, Tank and Nozzle");
        return;
    }

    addAllocationRow(product, tank, nozzle);
}

/* ===============================
   ADD ROW + HIDDEN INPUTS
================================ */
function addAllocationRow(product, tank, nozzle) {
    const tableBody = document.getElementById("editAllocatedBody");

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${product}</td>
        <td>${tank}</td>
        <td>${nozzle}</td>
        <td>
            <button type="button"
                class="btn btn-danger btn-sm"
                onclick="removeRow(this)">
                Delete
            </button>
        </td>
    `;
    tableBody.appendChild(row);

    // ðŸ”¥ FIX: REMOVE [] FROM NAMES
    const div = document.createElement("div");
    div.innerHTML = `
        <input type="hidden" name="product_name" value="${product}">
        <input type="hidden" name="tank_name" value="${tank}">
        <input type="hidden" name="nozzle_name" value="${nozzle}">
    `;
    dynamicAllocations.appendChild(div);
}

/* ===============================
   REMOVE ROW + HIDDEN INPUT
================================ */
function removeRow(btn) {
    const row = btn.closest("tr");
    const index = Array.from(row.parentNode.children).indexOf(row);

    row.remove();
    dynamicAllocations.children[index].remove();
}

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", loadStaffDetails);
</script>


{% endblock %}
