{% extends "masters/base.html" %}
{% load static %}

{% block content %}

<div class="row">
    <h3 class="mt-1 mb-4">Suppliers</h3>

    <!-- ================= SUPPLIER FORM ================= -->
    <div class="col-xl-6">
        <div class="card custom-card">
            <div class="card-header">
                <h5>{% if editing_supplier %}Edit Supplier{% else %}Add Supplier{% endif %}</h5>
            </div>

            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}

                    {% if editing_supplier %}
                        <input type="hidden" name="supplier_id" value="{{ editing_supplier.id }}">
                    {% endif %}

                    <!-- NON FIELD ERRORS -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <div class="row g-3">

                        <div class="col-md-4">
                            <label class="form-label">Supplier Name<span class="text-danger">*</span></label>
                            {{ form.supplier_name }}
                            <div class="text-danger small">{{ form.supplier_name.errors.0 }}</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Address</label>
                            {{ form.address }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Phone</label>
                            {{ form.phone }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Mobile<span class="text-danger">*</span></label>
                            {{ form.mobile }}
                            <div class="text-danger small">{{ form.mobile.errors.0 }}</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Contact Person</label>
                            {{ form.contact_person }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Contact Mobile</label>
                            {{ form.contact_person_mobile }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">GST No</label>
                            {{ form.gst_no }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">PAN</label>
                            {{ form.pan }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">TAN</label>
                            {{ form.tan }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Open Balance<span class="text-danger">*</span></label>
                            {{ form.open_balance }}
                            <div class="text-danger small">{{ form.open_balance.errors.0 }}</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Dr / Cr <span class="text-danger">*</span></label>
                            {{ form.dr_cr }}
                            <div class="text-danger small">{{ form.dr_cr.errors.0 }}</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            {{ form.date }}
                        </div>

                        <div class="col-md-4 mt-4">
                            <div class="form-check">
                                {{ form.customer }}
                                <label class="form-check-label">Customer</label>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Credit Period (Days)</label>
                            {{ form.credit_period_days }}
                        </div>

                        <div class="col-md-4 mt-4">
                            <div class="form-check">
                                {{ form.interstate_supplier }}
                                <label class="form-check-label">Interstate Supplier</label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_active }}
                                <label class="form-check-label">Active</label>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Remark</label>
                            {{ form.remark }}
                        </div>

                    </div>

                    <hr>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-warning">
                            {% if editing_supplier %}Update{% else %}Save{% endif %}
                        </button>
                        <a href="{% url 'masters:supplier' %}" class="btn btn-danger-light">Cancel</a>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- ================= SUPPLIER LIST ================= -->
    <div class="col-xl-6">
        <div class="card custom-card">
            <div class="card-header">
                <h5>Supplier List</h5>
            </div>

            <div class="card-body table-responsive">
                                <div class="d-flex justify-content-between">
                    <!-- Export Buttons -->
                    <div class="">
                        <a href="{% url 'masters:export_supplier_master' 'excel' %}" class="btn btn-success">
                            <i class="ri-file-excel-2-line"></i> Export Excel
                        </a>
                        <a href="{% url 'masters:export_supplier_master' 'pdf' %}" class="btn btn-danger">
                            <i class="ri-file-pdf-line"></i> Export PDF
                        </a>
                    </div>
              <div class="col-md-3">
    <input type="search"
           class="form-control search-table"
           data-target="#searchTable"
           placeholder="Search...">
</div>

                </div><br>

                <table class="table table-bordered" id="searchTable">

                    <thead>
                        <tr>
                            <th>Slno</th>
                            <th>Action</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for supplier in suppliers %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <a href="?edit={{ supplier.id }}" class="text-info">
                                    <i class="ri-edit-line"></i>
                                </a>

<a href="javascript:void(0);"
   data-url="{% url 'masters:delete_supplier' supplier.id %}"
   class="text-danger fs-14 lh-1 delete-btn"
   title="Delete">
    <i class="ri-delete-bin-5-line"></i>
</a>




                            </td>
                            <td>{{ supplier.supplier_name }}</td>
                            <td>{{ supplier.mobile }}</td>
                            <td>
                                {% if supplier.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No suppliers found</td>
                        </tr>
                        {% endfor %}

                        <tr id="noSearchResult" style="display: none;">
    <td colspan="5" class="text-center text-danger">
        No searched supplier found
    </td>
</tr>
                    </tbody>
                </table>
            </div>

<!-- pagination -->
            <div class="card-footer border-top-0">
    <div class="d-flex align-items-center flex-wrap overflow-auto">

        <div class="mb-2 mb-sm-0">
            Showing
            <b>{{ suppliers.start_index }}</b> to
            <b>{{ suppliers.end_index }}</b> of
            <b>{{ suppliers.paginator.count }}</b> Suppliers
        </div>

        <div class="ms-auto">
            <ul class="pagination mb-0 overflow-auto">

                {% if suppliers.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ suppliers.previous_page_number }}">
                        <i class="ri-arrow-left-s-line"></i>
                    </a>
                </li>
                {% endif %}

                {% for i in suppliers.paginator.page_range %}
                    {% if suppliers.number == i %}
                        <li class="page-item active">
                            <span class="page-link">{{ i }}</span>
                        </li>
                    {% elif i >= suppliers.number|add:'-2' and i <= suppliers.number|add:'2' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if suppliers.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ suppliers.next_page_number }}">
                        <i class="ri-arrow-right-s-line"></i>
                    </a>
                </li>
                {% endif %}

            </ul>
        </div>
    </div>
</div>

        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('.delete-btn').forEach(function (btn) {

        btn.addEventListener('click', function () {

            const deleteUrl = this.getAttribute('data-url');

            Swal.fire({
                title: 'Are you sure?',
                text: 'This supplier will be permanently deleted!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {

                if (result.isConfirmed) {

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = deleteUrl;

                    const csrfToken = document.querySelector(
                        'input[name="csrfmiddlewaretoken"]'
                    ).value;

                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;

                    form.appendChild(csrfInput);
                    document.body.appendChild(form);
                    form.submit();
                }
            });

        });

    });

});
</script>


{% if messages %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    {% for message in messages %}
        Swal.fire({
            icon: '{{ message.tags }}' === 'success' ? 'success' : 'error',
            title: '{{ message }}',
            timer: 2500,
            showConfirmButton: false
        });
    {% endfor %}
});
</script>
{% endif %}



<script>
document.addEventListener('DOMContentLoaded', function () {

    const searchInput = document.querySelector('.search-table');
    const table = document.querySelector(searchInput.dataset.target);
    const rows = table.querySelectorAll('tbody tr:not(#noSearchResult)');
    const noResultRow = document.getElementById('noSearchResult');

    searchInput.addEventListener('keyup', function () {
        const searchValue = this.value.toLowerCase().trim();
        let visibleCount = 0;

        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();

            if (rowText.includes(searchValue)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Show / hide "No result" row
        if (visibleCount === 0) {
            noResultRow.style.display = '';
        } else {
            noResultRow.style.display = 'none';
        }
    });

});
</script>



{% endblock %}
